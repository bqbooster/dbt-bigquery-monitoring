name: Cleanup Test Datasets

on:
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no actual deletion)'
        required: false
        type: boolean
        default: false
      max_datasets:
        description: 'Maximum number of datasets to delete (leave empty for unlimited)'
        required: false
        type: string
        default: ''

env:
  DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT: ${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT }}
  DBT_ENV_SECRET_BIGQUERY_TEST_STORAGE_PROJECT: ${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_STORAGE_PROJECT }}

jobs:
  cleanup:
    name: Cleanup Test Datasets from BigQuery
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-bigquery
      
      - name: Write service account keyfile
        run: |
          if [ -z "${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT }}" ]; then
            echo "Error: DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT is not defined."
            exit 1
          else
            echo ${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT }} | base64 -d > ./keyfile.json
          fi
      
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_SERVICE_ACCOUNT }}
      
      - name: Run cleanup script (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=./keyfile.json
          
          MAX_DATASETS_ARG=""
          if [ -n "${{ github.event.inputs.max_datasets }}" ]; then
            MAX_DATASETS_ARG="--max-datasets ${{ github.event.inputs.max_datasets }}"
          fi
          
          python scripts/cleanup_test_datasets.py \
            --project "${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_STORAGE_PROJECT }}" \
            --dry-run \
            --verbose \
            $MAX_DATASETS_ARG
      
      - name: Run cleanup script (actual deletion)
        if: github.event.inputs.dry_run != 'true'
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=./keyfile.json
          
          MAX_DATASETS_ARG=""
          if [ -n "${{ github.event.inputs.max_datasets }}" ]; then
            MAX_DATASETS_ARG="--max-datasets ${{ github.event.inputs.max_datasets }}"
          fi
          
          python scripts/cleanup_test_datasets.py \
            --project "${{ secrets.DBT_ENV_SECRET_BIGQUERY_TEST_STORAGE_PROJECT }}" \
            --verbose \
            $MAX_DATASETS_ARG
      
      - name: Cleanup keyfile
        if: always()
        run: |
          if [ -f ./keyfile.json ]; then
            rm ./keyfile.json
          fi
